# 被侵入后的网络安全-有敌人的分布式一致性-论文导读

### 作者: 软件工程16级11班侯逸骅/54160625/55161118

### 摘要

以往网络安全一般关注的是从网络层面上杜绝入侵的可能,尽可能的防患于未然,但是实际上再完美的系统也有漏洞,总会被人找到,遭到入侵是不可避免的,即使采用了入侵检测系统,检测到入侵也是被入侵之后,敌人很可能已经造成了损失,如何使遭到入侵后第一时间的损失降到最低,成为值得讨论的问题.

目前的服务端几乎都是分布式集群,被部分侵入的可能性很大,如何在这种情况下保持数据的一致性,而又不中断服务?

现在区块链技术非常火,尤其是各种虚拟币,但是大多数算法设计之初,都是用来对付机器数较少的情况,一般是企业不超过一百台机器的集群,而不是现在较为流行的公有链,动不动几百万台机器.

关键词: 分布式,一致性,拜占庭故障

## 1.介绍

实际上,这个问题在传统计算机网络的研究早有提及,被称作分布式一致性问题,分布式系统通常由异步网络连接的多个节点构成，每个节点有独立的计算和存储，节点之间通过网络通信进行协作。分布式一致性指多个节点对某一变量的取值达成一致，一旦达成一致，则变量的本次取值即被确定.

我们需要在有敌人侵入网络的情况下保证分布式一致性,这非常难以做到,本文从实现的可能性讲起,然后讨论没有敌人情况下的分布式一致性,较详细的描述了Paxos算法,然后讲解有敌人情况下的分布式一致性,最后是总结.


## 2.可能性
首先必须确定我们最好能做到怎样,这样才不至于为了不可能的目标瞎折腾.是否存在一个系统,能够耐受任意的错误信息,只要这些信息的频率在一定限度之内?答案是否定的.[1]证明了,即使对于及其简单的问题,只要有一台机子是有故障的,在没有同步时钟的系统中,也无法保持数据的一致性,简述一下,具体的证明在论文中

定义:对于一个系统,如果对于它的一个状态,干掉任何一台机器或者修改其输出,不影响系统的输出结果,则称其为确定状态,否则称为不确定状态

- 引理1:对于任何一个系统,即使是极其简单的系统,也总是存在初始状态是不确定状态
- 引理2:从不确定状态进行状态转换总是能转到一个不确定状态

可推得定理:一个系统可能一直运行在不确定状态之中,永远可能被一个进程的错误KO.

而CAP定理[2]则证明,一致性,可用性,网络分区在异步情况下三者无法同时达成,以及,三者只取其二是可行的

简单来说,如果出现了网络分区情况,那么对一个分区的节点进行写入,对其他节点进行读取,如果保留可用性,读出来的结果一定不正确,因为其他分区没有接收到写入请求,如果保留一致性,那就没办法给客户端返回结果,可用性就被破坏了

## 2.没有敌人的情况
即使没有敌人,分布式一致性仍然是一个非常困难的问题,因为机子随时可能和其他机子的网络断开,并且可能出现故障.

由于我们认为安全是最重要的问题,可用性则在绝大多数时间保持即可,机器出现问题时,虽然服务质量下降,但是仍然基本可用即可,出现敌人的情况过于复杂,先从较为简单的情况入手,一步步改进,才能较为容易的理解对付复杂情况的算法.按照CAP定理的说法,也就是说,我们要构造一个CP系统,同时在出现故障时保持一定程度上的A,多种算法可以解决这个问题,其中具有代表性的有Paxos[3][4][5],Raft[6],ZAB[7],Viewstamped Replication[8]

## 2.1 Paxos
实际上分布式一致性问题的场景和开会是一样的,大家各抒己见,只要最终达成一致意见即可(一致性),有资格参会者(所有主机)中只要超过一半的人同意了会议决定,即使以后上次没来参会的人来参会了(宕机恢复)以后任意拉出来一半有资格参会者,总有一个人知道最新的决议是什么.而没来参会的人自己开的小会(网络分区),由于人数达不到有资格参会者的一半,所以不可能通过任何决议,保证了所有有资格参会者的意见一致.这就是Paxos模型
```
人{
    自己的议员编号i
    最新已接受提案号AcceptN
    最新已提出提案号MaxN
    最新已接受提案值AcceptV
}
```
每个人都会提出自己的提案,并附上自己的提案号,假设有10个人有资格参会,议员编号从0到9,为了让大家的提案号不撞号,可以让提案号=10*j+i,j为自己已经接受的提案个数.

人---->广播:我要发新提案,编号是N

其他人接受到请求后,判断这个提案够不够新,如果够新,则告诉提出者:我可能接受这个请求,即承诺promise
```java
promise(N)
{
    if(N < MaxN)
    {
        //我已经收到比你更新的提案了
        return reject;
    }
    if(N >= MaxN)
    {
        MaxN = N;
        if(AcceptN != null)
        {
            return {ok, AcceptN, AcceptV};
        }
        return ok;
    }
}
```
收到超过一半人的承诺之后

人----> 回复ok者 : 接受我的新提案(N, V), V是提案内容
```java
accept(N, V)
{
    if (N < MaxN)
    {
        //可能是请求者断网了,断网期间有新提案,他没收着,所以他还以为他的提案能被接受,也有可能是同一个提案周期,他被拒绝是因为别的请求者的i比较大.可见i不只是一个机器号,同时还是机器的权限级,权限级高者,面临提案冲突时获胜
        return reject;
    }
    else
    {
        AcceptN = N;
        AcceptV = V;
        return ok;
    }
}
```
Accept者超过一半,即议案通过
由于发现i是权限级,且分布式集群最好权限级是平等的,所以可以让提案号=10*j+(i+j)%10
这样每一轮的权限级是确定的,但轮与轮之间权限级是轮流坐庄的

## 2.2 Raft,ZAB算法

由于Paxos不易理解,不易实现,而且由于允许多个提案提出者,可能产生过多的冲突,存在性能问题,所以有人重新发明了这个轮子,就是Raft和ZAB,ZAB就是大名鼎鼎的Apache Zookeeper的核心,而Raft在很多分布式数据库的源码中都能看到

其实Raft和ZAB的思想非常简单,仍然是开大会,但是先选出个主席,以后都听他的,除非他没来,启动时仍然是Paxos,每台机器都在启动后随机延迟,然后提出提案,V=自己的机器号,通过的提案中的V即唯一的机器号i作为主席(leader),主席负责接受外来的请求并提出新提案.主席要定期发心跳包进行同步,告诉其他机器我还活着,如果其他机器过一段时间没收到主席的消息了,就会揭竿而起,提出选自己为新主席,仍然按照Paxos的规矩来,超过半数通过即选出新主席

ZAB和Raft的不同点在于提案号的算法不同,ZAB的提案号称为ZXID,ZXID=高32位主席id|低32位递增计数器,Raft的提案号称作log id,算法同Paxos,但是仅允许接受了最多提案的节点成为新主席


## 2.3 产品例子
Google Spanner[9],是Google的分布式数据库,采用Multi-Paxos算法为spanserver的多个replica提供同步,默认选举timeout为10秒,使用大杀器GPS+原子钟(钞能力)给分布式系统带来几乎同步的时钟


## 3. 有敌人的情况
但是我们要面对敌人入侵的情况,不只是有人可能不参会,参会者中还可能有叛徒信口胡说,叛徒之间也可能达成一致.绝对不能让入侵者的决议通过,这种情况称为拜占庭故障,现在最常见的使用场景是数字货币,所以那边发展的最好,产生了很多种算法.其中具有代表性的是PBFT[10],PoW(用于比特币)[11]和PoS(用于以太币)

## 3.1 PBFT
类似于上面提到的分布式一致性算法,和Viewstamped Replication一脉相承,不过这次需要叛徒不超过1/3,即叛徒个数为f时,总机器数为3f+1才行,可以理解为有1/3的叛徒否决了我们的提案,但是忠诚者中的大半仍然比叛徒多,哪怕忠诚者挂掉一小半,仍然可以做出正确的决议

由于是用于少量机器的算法,所以主要应用于私有链和联盟链,论文中以NFS作为例子,实现了PBFT的NFS性能仅比普通NFS下降了3%
## 3.2 PoW:proof of work工作量证明
如果说上面的方法是以巧妙的算法设计决定了决定权的归属,而PoW就是一种暴力美学了,协议提出一系列问题,谁先求解出来一道的答案就拥有数据的一次写入权限,然后继续下一道题.

问题的例子:bitcoin论文中,以寻找sha256算法算出的串以n个0问题为例,难度为指数增长,而验证只需计算一次sha256,只需保证欺诈者的算力不超过总算力的1/2,情况就可以控制

另外还有PoS和DPoS算法,解决了PoW计算量大的缺点可进一步阅读

## 3.3 产品例子
比特币:PoW,以太币:PoS


## 参考资料
[1] Impossibility of Distributed Consensus with One Faulty Process
[2] Brewer’s Conjecture and the Feasibility of Consistent, Available, Partition-Tolerant Web Services,Seth Gilbert,Nancy Lynch
[3] The Part-Time Parliament,Leslie Lamport,ACM Transactions on Computer Systems 16, 2 (May 1998), 133-169. 
[4] Paxos Made Simple,Leslie Lamport ACM SIGACT News (Distributed Computing Column) 32, 4 (Whole Number 121, December 2001)
[5] 分布式系列文章——Paxos算法原理与推导 https://www.cnblogs.com/linbingdong/p/6253479.html
[6] In Search of an Understandable Consensus Algorithm(Extended Version) Diego Ongaro and John OusterhoutStanford University
[7] ZooKeeper: Wait-free coordination for Internet-scale systems
[8] Viewstamped Replication: A General Primary Copy.
[9] Spanner: Google’s Globally-Distributed Database
[10] Practical Byzantine Fault Tolerance,Miguel Castro and Barbara Liskov Laboratory for Computer Science, Massachusetts Institute of Technology
[11] Bitcoin: A Peer-to-Peer Electronic Cash System,Satoshi Nakamoto
[12] 分布式理论(七)—— 一致性协议之 ZAB https://www.cnblogs.com/stateis0/p/9062133.html
[13] 理解Google Spanner(1)：数据复制与分片 https://www.jianshu.com/p/c6e1034ac922
[14] 分布式一致性与共识算法 https://blog.csdn.net/omnispace/article/details/79326095